generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 1. PRODUCTOS
model Product {
  id            Int      @id @default(autoincrement())
  name          String
  price         Float
  originalPrice Float
  stock         Int
  images        Json     
  isActive      Boolean  @default(true)
  description   String   @default("")
  
  items         OrderItem[]

  favoritedBy   Favorite[]

  rating        Float    @default(0.0) 
  totalReviews  Int      @default(0) 
  
  reviews       Review[] 

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// 2. ORDEN (ENCABEZADO) -> AQUI VA EL USUARIO
model Order {
  id          Int         @id @default(autoincrement())
  total       Float       
  items       OrderItem[] 
  
  // --- CORRECCI칍N: La relaci칩n va aqu칤 ---
  userId      Int?        // Puede ser null si permites compra invitado
  user        User?       @relation(fields: [userId], references: [id])
  
  createdAt   DateTime    @default(now())
}

// 3. ITEMS DE LA ORDEN (RENGLONES)
model OrderItem {
  id          Int      @id @default(autoincrement())
  
  orderId     Int
  order       Order    @relation(fields: [orderId], references: [id])

  productId   Int
  product     Product  @relation(fields: [productId], references: [id])

  productName String
  unitPrice   Float     
  quantity    Int
  subtotal    Float    

  // --- CORRECCI칍N: Aqu칤 NO va el usuario. Ya est치 en la Orden padre. ---
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String   
  name      String?
  role      String   @default("CLIENT") 
  
  // Esto ahora funcionar치 porque Order ya tiene el campo userId
  orders    Order[]  

  favorites Favorite[]

  reviews  Review[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Favorite {
  user       User     @relation(fields: [userId], references: [id])
  userId     Int

  product    Product  @relation(fields: [productId], references: [id])
  productId  Int

  createdAt  DateTime @default(now()) // Para saber cu치ndo le dio like

  // CLAVE COMPUESTA:
  // Esto es vital. Asegura que un usuario NO pueda darle like 
  // dos veces al mismo producto. La combinaci칩n userId + productId es 칰nica.
  @@id([userId, productId])
}

model Review {
  id        Int      @id @default(autoincrement())
  rating    Int      // Del 1 al 5
  comment   String?  // Opcional: "Estaba riqu칤sima"
  createdAt DateTime @default(now())

  // Relaciones
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  
  productId Int
  product   Product  @relation(fields: [productId], references: [id])

  // 游 CANDADO DE SEGURIDAD:
  // Esto impide que el mismo usuario vote 2 veces al mismo producto
  @@unique([userId, productId])
}